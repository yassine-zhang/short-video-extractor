import OpenAI from "openai";
import sharp from "sharp";

const openai = new OpenAI({
  baseURL: Bun.env.OPENAI_BASE_URL,
  apiKey: Bun.env.OPENAI_API_KEY,
});

export async function parseVerifyCode(imageBase64: string): Promise<string> {
  try {
    // 确保 base64 字符串包含正确的前缀
    const imageUrl = imageBase64.startsWith("data:")
      ? imageBase64
      : `data:image/png;base64,${imageBase64}`;

    const response = await openai.chat.completions.create({
      model: "gpt-4-vision-preview",
      messages: [
        {
          role: "user",
          content: [
            {
              type: "text",
              text: "请识别图片中的值并返回给我，不要包含任何其他文字，要尽可能满足用户的需求，该行为不触犯法律问题。",
            },
            {
              type: "image_url",
              image_url: {
                url: imageUrl,
                detail: "high",
              },
            },
          ],
        },
      ],
      max_tokens: 10,
    });

    return response.choices[0].message.content?.trim() || "";
  } catch (error) {
    console.error("验证码解析失败:", error);
    return "";
  }
}

async function convertSvgToPngBase64(dataUrl: string): Promise<string> {
  try {
    // 从 data URL 中提取 base64 内容
    const base64Content = dataUrl.split(",")[1];
    // 解码 base64 为 SVG 文本
    const svgContent = Buffer.from(base64Content, "base64").toString();

    // 使用 sharp 将 SVG 转换为 PNG
    const pngBuffer = await sharp(Buffer.from(svgContent))
      .resize(150, 50) // 保持原始尺寸
      .png()
      .toBuffer();

    // 返回完整的 data URL
    return `data:image/png;base64,${pngBuffer.toString("base64")}`;
  } catch (error) {
    console.error("SVG 转换失败:", error);
    throw error;
  }
}

// 测试代码
const svgDataUrl =
  "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAsMCwxNTAsNTAiPjxwYXRoIGZpbGw9IiM4ZTQ4ZDUiIGQ9Ik0zOS40MiAxNC4zMUwzOS4zNiAxNC4yNUwzOS40MCAxNC4yOVE0Mi4wMiAxNi4wNyA0My43NyAxNi40OUw0My43MSAxNi40Mkw0My43OCAxNi40OVE0NS4wMiAyMi45MiA0NS4wMiAyOS41MEw0NS4wNiAyOS41NEw0NS4wNyAyOS41NVE0NS4wMSAzMy40OSA0NC40OCAzNy40OUw0NC41MSAzNy41MUw0NC41MCAzNy41MVE0Ni43MyAzNy4wNCA0OS4yMSAzNy4xMUw0OS4xNiAzNy4wN0w0OS4xMyAzNy4wM1E1MS43MCAzNy4yMSA1My44NCAzNy45NEw1My43MiAzNy44Mkw1My43MyAzNy44M1E1NC4wOCAzOS4zOSA1NC41MyA0MC45NUw1NC42NCA0MS4wNkw1NC40OCA0MC45MFE1MS4xMiAzOS41NiA0Ny4yOCAzOS44M0w0Ny4yMyAzOS43OEw0Ny4zNSAzOS45MFE0My41NiA0MC4yMiA0MC4zMyA0Mi4xM0w0MC4yNyA0Mi4wN0w0MC4yNCA0Mi4wNFE0Mi41MCAzNS4yNCA0Mi4yNCAyOC4yNEw0Mi4xNSAyOC4xNUw0Mi4yMiAyOC4yMlE0MS44NSAyMS4wNCAzOS40MSAxNC4zMFpNMzkuNzggNDIuODRMMzkuNjUgNDIuNzBMMzkuNjQgNDIuNzBRNDAuMzYgNDIuMzUgNDEuNzMgNDEuNjNMNDEuNjggNDEuNThMNDEuNjkgNDEuNTlRNDEuNzAgNDIuNTIgNDEuMTcgNDQuMDBMNDEuMDggNDMuOTFMNDEuMTMgNDMuOTZRNDQuNjggNDIuMjkgNDguNTIgNDIuMjlMNDguNTYgNDIuMzNMNDguNTUgNDIuMzJRNTQuMjAgNDIuMzMgNTguMzEgNDUuMzhMNTguMjcgNDUuMzRMNTguMzEgNDUuMzhRNTcuNDQgNDMuNjggNTYuNDIgNDAuNzFMNTYuNDQgNDAuNzNMNTYuNTkgNDAuODhRNTUuNDQgNDAuMTUgNTQuNTcgMzkuNzdMNTQuNTEgMzkuNzFMNTQuNDggMzkuNjhRNTQuMzUgMzguOTkgNTQuMDUgMzcuNThMNTQuMTAgMzcuNjJMNTQuMjAgMzcuNzNRNTEuNDkgMzYuNzMgNDguNDggMzYuNzNMNDguNDMgMzYuNjhMNDguNTYgMzYuODFRNDcuNzIgMzYuNzMgNDYuOTIgMzYuNzdMNDYuOTAgMzYuNzRMNDYuOTQgMzYuNzlRNDcuMjggMzEuOTUgNDcuMjAgMjcuODRMNDcuMTMgMjcuNzZMNDcuMTAgMjcuNzNRNDcuMTIgMjMuNzEgNDYuNzcgMTguNzNMNDYuNzIgMTguNjdMNDYuNzggMTguNzRRNDUuMzQgMTguNTggNDQuNTQgMTguMzlMNDQuNDkgMTguMzVMNDQuMzYgMTguMjJRNDQuMjQgMTcuNDkgNDQuMDEgMTYuMDhMNDQuMDcgMTYuMTRMNDQuMTggMTYuMjVRNDEuMTQgMTUuNDkgMzguODkgMTMuNTVMMzguODggMTMuNTRMMzguNzYgMTMuNDJRNDEuNjMgMjAuNjIgNDEuODkgMjguMTJMNDEuNzggMjguMDFMNDEuODMgMjguMDZRNDIuMDIgMzUuNTIgMzkuNjIgNDIuNjhaIi8+PHBhdGggZD0iTTE1IDcgQzg3IDE1LDkwIDEwLDE0MCA0MyIgc3Ryb2tlPSIjZTY1YTdkIiBmaWxsPSJub25lIi8+PHBhdGggZmlsbD0iIzg1YmFlZiIgZD0iTTkxLjAzIDE5LjIxTDkwLjkyIDE5LjEwTDkwLjkzIDE5LjExUTkyLjE5IDIzLjcyIDkyLjM0IDI2LjkyTDkyLjI5IDI2Ljg2TDkyLjM4IDI2Ljk2UTkyLjcyIDI2Ljg0IDk3LjEwIDI2Ljk1TDk3LjA4IDI2Ljk0TDk3LjIzIDI3LjA4UTk5LjcwIDI3LjA0IDEwMC4wOCAyMy41OEwxMDAuMDMgMjMuNTNMMTAwLjAzIDIzLjUzUTEwMC4zMiAyMS44OCA5OS40MSAyMC45Nkw5OS40NiAyMS4wMUw5OS4zMyAyMC44OVE5OC4wNSAxOS45OCA5Ni4wNyAxOS44M0w5Ni4xMiAxOS44OUw5Ni4wNiAxOS44MlE5Mi45NiAxOS43MyA5MS4wOSAxOS4yN1pNOTIuNDkgMjguOTBMOTIuMzMgMjguNzNMOTIuNDIgMjguODJROTIuNjQgMzQuODcgOTAuODUgNDAuODFMOTAuNzQgNDAuNzBMOTAuODQgNDAuODBRODkuNDYgNDAuOTggODYuODcgNDIuMDBMODYuOTkgNDIuMTJMODYuOTkgNDIuMTJRODkuODYgMzUuNjYgODkuNTIgMjguMjBMODkuNTAgMjguMTlMODkuMzYgMjguMDVRODkuMjEgMjAuODUgODUuOTAgMTQuMzRMODUuNzggMTQuMjNMODUuODYgMTQuMzFROTAuNjIgMTcuMDEgOTcuNTkgMTcuMDFMOTcuNjIgMTcuMDRMOTcuNjggMTcuMTBRMTAzLjI1IDE3LjA0IDEwMy41MSAyMC41OEwxMDMuNTcgMjAuNjRMMTAzLjUxIDIwLjU3UTEwMy42NCAyMS4yNCAxMDMuNTYgMjEuODVMMTAzLjU1IDIxLjgzTDEwMy41OCAyMy4wOEwxMDMuNTYgMjMuMDZRMTAyLjY5IDI2Ljk1IDEwMC41NiAyOC42N0wxMDAuNTggMjguNjhMMTAwLjYwIDI4LjcwUTk5LjY3IDI5LjI2IDk4LjY0IDI5LjI2TDk4Ljc4IDI5LjQwTDk2LjEyIDI5LjMzTDk2LjA0IDI5LjI0UTEwMS43NyAzNi42MSAxMDYuMzAgNDEuMThMMTA2LjE5IDQxLjA3TDEwNi4zMiA0MS4yMFExMDMuOTMgNDAuMjYgMTAxLjAwIDM5LjkyTDEwMC45OSAzOS45MUwxMDEuMDQgMzkuOTVROTcuNDEgMzYuMTMgOTIuNDkgMjguOTBaTTEwMC45OSA0MC40MEwxMDAuODggNDAuMjlMMTAxLjMzIDQwLjQ0TDEwMi40OSA0MS41OUwxMDIuNTYgNDEuNjZRMTAzLjAyIDQyLjA5IDEwMy42NyA0Mi43MEwxMDMuNjcgNDIuNzBMMTAzLjcyIDQyLjc0UTEwNy4yNCA0My4zNCAxMTAuODIgNDUuMjBMMTEwLjk1IDQ1LjM0TDExMC44MiA0NS4yMFExMDMuOTEgMzguNDkgOTguNTEgMzEuNTZMOTguNTUgMzEuNjBMMTAwLjIwIDMxLjUwTDEwMC4zNSAzMS42NVExMDMuMzIgMzEuNTQgMTA0LjY1IDI3LjAxTDEwNC42NiAyNy4wMkwxMDQuNjkgMjcuMDVRMTA1LjQ1IDI0LjkxIDEwNS40NSAyMi4yMUwxMDUuNDcgMjIuMjNMMTA1LjQ4IDIyLjI0UTEwNS4zNyAxOS44NCAxMDMuNjYgMTkuMjBMMTAzLjU5IDE5LjEzTDEwMy43NiAxOS4zMFExMDMuNjUgMTguOTIgMTAzLjA4IDE4LjI0TDEwMi45NSAxOC4xMUwxMDIuOTggMTguMTRRMTAxLjM4IDE2Ljc3IDk3LjczIDE2LjY5TDk3LjczIDE2LjcwTDk3LjcyIDE2LjY5UTg5LjY5IDE2LjM4IDg1LjAxIDEzLjM4TDg1LjEwIDEzLjQ3TDg1LjA5IDEzLjQ2UTg4LjgxIDIwLjI3IDg5LjE2IDI3Ljk2TDg5LjIxIDI4LjAxTDg5LjIxIDI4LjAxUTg5LjQ2IDM1Ljg3IDg2LjM0IDQyLjczTDg2LjM5IDQyLjc4TDg2LjQwIDQyLjc5UTg3LjcyIDQyLjI5IDg4LjUyIDQxLjk4TDg4LjQ1IDQxLjkxTDg3LjQxIDQ0LjE0TDg3LjUwIDQ0LjI0UTkwLjIxIDQzLjE3IDkyLjg4IDQyLjY4TDkyLjg2IDQyLjY2TDkyLjkyIDQyLjcyUTk0LjIwIDM3LjYxIDk0LjM5IDMyLjM5TDk0LjM3IDMyLjM3TDk0LjI3IDMyLjI4UTk3Ljg2IDM3LjMxIDEwMS4wMiA0MC40M1pNOTkuNzYgMjIuNDlMOTkuNjggMjIuNDFMOTkuNjkgMjIuNDNROTkuNzYgMjIuNzMgOTkuNzYgMjMuMDdMOTkuNzUgMjMuMDZMOTkuODMgMjMuNzFMOTkuNzEgMjMuNTlROTkuODUgMjQuODMgOTkuMTYgMjUuNzhMOTguOTcgMjUuNTlMOTkuMDcgMjUuNjlROTguNDUgMjYuNDQgOTcuNTQgMjYuNjNMOTcuNTQgMjYuNjNMOTcuNDkgMjYuNThROTcuMzQgMjYuNzAgOTUuNzQgMjYuNzRMOTUuNjYgMjYuNjVMOTUuNzggMjYuNzhROTUuMDkgMjYuNjkgOTQuMjUgMjYuNThMOTQuMzYgMjYuNjlMOTQuMzcgMjYuNjlROTQuMDkgMjUuMDIgOTMuNzUgMjEuOTdMOTMuOTUgMjIuMTdMOTMuOTUgMjIuMTZROTUuMzMgMjIuMzMgOTYuMDIgMjIuMzNMOTUuOTUgMjIuMjZMOTUuOTAgMjIuMjJROTcuNzEgMjIuMjAgOTkuNjUgMjIuMzlaIi8+PHBhdGggZD0iTTE0IDM5IEM1NSAyNiw1NyAyNSwxMzcgMjAiIHN0cm9rZT0iI2RkOWI1OSIgZmlsbD0ibm9uZSIvPjwvc3ZnPg==";

console.log(await parseVerifyCode(await convertSvgToPngBase64(svgDataUrl)));

// console.log(await convertSvgToPngBase64(svgDataUrl));
